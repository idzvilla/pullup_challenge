# Инструкция по деплою на Railway

## Шаг 1: Подготовка

1. Создайте бота в Telegram через [@BotFather](https://t.me/BotFather)
   - Отправьте `/newbot`
   - Следуйте инструкциям
   - Сохраните полученный токен

2. Создайте аккаунт на [Railway](https://railway.app)

## Шаг 2: Создание проекта на Railway

1. Войдите в Railway и создайте новый проект
2. Выберите "Deploy from GitHub repo" (если у вас есть репозиторий) или "Empty Project"

## Шаг 3: Добавление PostgreSQL

1. В проекте нажмите "+ New"
2. Выберите "Database" → "Add PostgreSQL"
3. Railway автоматически создаст базу данных и установит переменную `DATABASE_URL`

## Шаг 4: Настройка переменных окружения

В настройках проекта (Settings → Variables) добавьте:

- `TELEGRAM_BOT_TOKEN` - токен вашего бота от @BotFather
- `CHALLENGE_START_DATE` - `2025-12-01` (дата начала челленджа)
- `CHALLENGE_END_DATE` - `2026-11-30` (дата окончания челленджа)
- `CHALLENGE_TARGET` - `18250` (цель челленджа)
- `REMINDER_TIME` - `09:00` (время напоминаний в UTC)

**Примечание:** `DATABASE_URL` будет автоматически установлен Railway при добавлении PostgreSQL.

## Шаг 5: Деплой

1. Если вы используете GitHub:
   - Подключите репозиторий
   - Railway автоматически определит `Procfile` и запустит бота

2. Если вы деплоите вручную:
   - Убедитесь, что `Procfile` присутствует в корне проекта
   - Railway автоматически определит Python проект и установит зависимости

## Шаг 6: Проверка

1. После деплоя проверьте логи в Railway
2. Найдите вашего бота в Telegram и отправьте `/start`
3. Проверьте, что бот отвечает и работает корректно

## Решение проблем

### Ошибка при сборке (Build failed) - установка libpq5
Если вы видите ошибку "Failed to build an image" или "process apt-get install -y libpq5 did not complete":

**РЕШЕНИЕ (используйте Dockerfile):**

1. В Railway перейдите в Settings вашего сервиса
2. Найдите раздел "Build"
3. В поле "Build Command" выберите или введите: `Use Dockerfile`
4. Или вручную установите:
   - Settings → Build → Buildpack: выберите "Dockerfile"
   - Или в "Build Command" оставьте пустым (Railway автоматически найдет Dockerfile)
5. Сохраните настройки
6. Запустите новый деплой (Redeploy)

**Альтернативное решение:**

Если Dockerfile не работает, попробуйте:
1. Settings → Build → Build Command: `pip install --no-cache-dir -r requirements.txt`
2. Settings → Build → Start Command: `python bot.py`
3. Убедитесь, что в Buildpack выбран "Nixpacks" (не "Docker")
4. Перезапустите деплой

**Почему это происходит:**
Railway автоматически пытается определить зависимости и устанавливает системные пакеты PostgreSQL, но `psycopg2-binary` уже содержит все необходимые библиотеки и не требует системных пакетов. Dockerfile обходит эту автоматическую установку.

### Бот не запускается
- Проверьте логи в Railway
- Убедитесь, что `TELEGRAM_BOT_TOKEN` установлен правильно
- Проверьте, что `DATABASE_URL` установлен (должен быть автоматически)

### Ошибки подключения к БД
- Убедитесь, что PostgreSQL добавлен в проект
- Проверьте, что `DATABASE_URL` установлен
- Проверьте логи на наличие ошибок подключения

### Напоминания не работают
- Убедитесь, что `REMINDER_TIME` установлен в формате `HH:MM` (UTC)
- Проверьте логи на наличие ошибок в job queue

## Мониторинг

- Логи доступны в разделе "Deployments" → выберите деплоймент → "View Logs"
- Метрики доступны в разделе "Metrics"

